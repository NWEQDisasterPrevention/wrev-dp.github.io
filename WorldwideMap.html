<!DOCTYPE html>
<html>
<head>
    <title>Earthquake Monitor - Real-time Visualization</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #e74c3c;
            text-align: center;
            margin-top: 0;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        #map { 
            height: 600px; 
            width: 100%; 
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
        }
        .controls-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .map-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .eq-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-left: auto;
        }
        .map-btn, .eq-btn {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .map-btn:hover, .eq-btn:hover {
            background-color: #2980b9;
        }
        .eq-btn {
            background-color: #e74c3c;
        }
        .eq-btn:hover {
            background-color: #c0392b;
        }
        .eq-btn.active {
            background-color: #c0392b;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3) inset;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9em;
            color: #7f8c8d;
        }
        .info-panel {
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            max-width: 300px;
        }
        .info-panel h4 {
            margin: 0 0 10px;
            color: #e74c3c;
        }
        .legend {
            line-height: 18px;
            color: #555;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
            border-radius: 50%;
        }
        .earthquake-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #e74c3c;
        }
        .earthquake-details h3 {
            margin-top: 0;
            color: #e74c3c;
        }
        .earthquake-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .earthquake-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .earthquake-item:hover {
            background-color: #f0f0f0;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #7f8c8d;
        }
        .refresh-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .last-updated {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        .connection-status {
            font-size: 0.9em;
            display: flex;
            align-items: center;
            margin-left: 15px;
        }
        .connection-status.connected {
            color: #27ae60;
        }
        .connection-status.disconnected {
            color: #e74c3c;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-indicator.connected {
            background-color: #27ae60;
            box-shadow: 0 0 5px #27ae60;
        }
        .status-indicator.disconnected {
            background-color: #e74c3c;
            box-shadow: 0 0 5px #e74c3c;
        }
        .timeline-container {
            margin-bottom: 20px;
            background-color: #f9f9f9;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .timeline-controls {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .timeline-btn {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            min-width: 80px;
        }
        .timeline-btn:hover {
            background-color: #2980b9;
        }
        .timeline-slider-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .timeline-slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            outline: none;
            border-radius: 4px;
        }
        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #3498db;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        .timeline-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #3498db;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        .timeline-label {
            font-size: 0.9em;
            color: #7f8c8d;
            min-width: 40px;
        }
        .speed-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .speed-control select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .timeline-info {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-left: auto;
        }
        /* Custom cluster styles */
        .marker-cluster {
            background-clip: padding-box;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        .marker-cluster div {
            width: 30px;
            height: 30px;
            margin-left: 5px;
            margin-top: 5px;
            text-align: center;
            border-radius: 15px;
            font-size: 12px;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Small cluster (few earthquakes) */
        .marker-cluster-small {
            background-color: rgba(181, 226, 140, 0.6);
        }
        .marker-cluster-small div {
            background-color: rgba(110, 204, 57, 0.9);
        }
        /* Medium cluster */
        .marker-cluster-medium {
            background-color: rgba(241, 211, 87, 0.6);
        }
        .marker-cluster-medium div {
            background-color: rgba(240, 194, 12, 0.9);
        }
        /* Large cluster (many earthquakes) */
        .marker-cluster-large {
            background-color: rgba(253, 156, 115, 0.6);
        }
        .marker-cluster-large div {
            background-color: rgba(241, 128, 23, 0.9);
        }
        /* Extra large cluster (significant number of earthquakes) */
        .marker-cluster-xlarge {
            background-color: rgba(255, 97, 97, 0.6);
        }
        .marker-cluster-xlarge div {
            background-color: rgba(220, 53, 69, 0.9);
        }
        /* Cluster hover effect */
        .marker-cluster:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        /* Cluster toggle button */
        .cluster-toggle {
            margin-top: 10px;
            display: flex;
            justify-content: center;
        }
        .cluster-toggle-btn {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .cluster-toggle-btn:hover {
            background-color: #2980b9;
        }
        .cluster-toggle-btn.active {
            background-color: #2980b9;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3) inset;
        }
        
        @media (max-width: 768px) {
            .timeline-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .timeline-info {
                margin-left: 0;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Earthquake Monitor - Real-time Visualization</h1>
        
        <div class="controls-container">
            <div class="map-controls">
                <button class="map-btn" id="btnSatellite">Satellite View</button>
                <button class="map-btn" id="btnStreet">Street View</button>
                <button class="map-btn" id="btnTerrain">Terrain View</button>
                <button class="map-btn active" id="btnCluster">Clustering On</button>
            </div>
            
            <div class="eq-controls">
                <button class="eq-btn active" id="btnPast24Hours">Past 24 Hours</button>
                <button class="eq-btn" id="btnPast7Days">Past 7 Days</button>
                <button class="eq-btn" id="btnPast30Days">Past 30 Days</button>
                <button class="eq-btn" id="btnRefresh">↻ Refresh Data</button>
            </div>
        </div>
        
        <div class="refresh-container">
            <div class="magnitude-filter">
                <label for="minMagnitude">Minimum Magnitude: </label>
                <select id="minMagnitude">
                    <option value="all">All</option>
                    <option value="2.5">2.5+</option>
                    <option value="4.5" selected>4.5+</option>
                    <option value="6">6.0+</option>
                </select>
            </div>
            <div style="display: flex; align-items: center;">
                <div class="last-updated" id="lastUpdated">Last updated: Never</div>
                <div id="connectionStatus" class="connection-status disconnected">
                    <span class="status-indicator disconnected"></span> Real-time updates inactive
                </div>
            </div>
        </div>
        
        <div id="map"></div>
        
        <div class="timeline-container">
            <div class="timeline-controls">
                <button id="playButton" class="timeline-btn">▶ Play</button>
                <div class="timeline-slider-container">
                    <span id="timelineStart" class="timeline-label">Start</span>
                    <input type="range" id="timelineSlider" min="0" max="100" value="100" class="timeline-slider">
                    <span id="timelineEnd" class="timeline-label">Now</span>
                </div>
                <div class="speed-control">
                    <label for="animationSpeed">Speed:</label>
                    <select id="animationSpeed">
                        <option value="2000">Slow</option>
                        <option value="1000" selected>Medium</option>
                        <option value="500">Fast</option>
                        <option value="200">Very Fast</option>
                    </select>
                </div>
                <div class="timeline-info">
                    <span id="currentTimeDisplay">Current Time: Not started</span>
                </div>
            </div>
        </div>
        
        <div class="earthquake-details">
            <h3>Recent Significant Earthquakes</h3>
            <div id="earthquakeList" class="earthquake-list">
                <div class="loading">Loading earthquake data...</div>
            </div>
        </div>
        
        <div class="footer">
            Data provided by USGS Earthquake Hazards Program
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
        // Initialize the map and set its view to the world
        var map = L.map('map', {
            zoomControl: false,  // We'll add zoom control in a custom position
            minZoom: 2,          // Prevent zooming out too far
            maxBounds: [         // Restrict panning to reasonable bounds
                [-90, -180],     // Southwest corner
                [90, 180]        // Northeast corner
            ]
        }).setView([20, 0], 2);

        // Add zoom control to the top-right corner
        L.control.zoom({
            position: 'topright'
        }).addTo(map);
        
        // Define different map tile layers
        var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        });
        
        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });
        
        var terrainLayer = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.png', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18
        });
        
        // Set the default layer
        streetLayer.addTo(map);
        
        // Add button event listeners for map layers
        document.getElementById('btnStreet').addEventListener('click', function() {
            map.removeLayer(satelliteLayer);
            map.removeLayer(terrainLayer);
            streetLayer.addTo(map);
        });
        
        document.getElementById('btnSatellite').addEventListener('click', function() {
            map.removeLayer(streetLayer);
            map.removeLayer(terrainLayer);
            satelliteLayer.addTo(map);
        });
        
        document.getElementById('btnTerrain').addEventListener('click', function() {
            map.removeLayer(streetLayer);
            map.removeLayer(satelliteLayer);
            terrainLayer.addTo(map);
        });
        
        // Add event listener for clustering toggle
        document.getElementById('btnCluster').addEventListener('click', function() {
            toggleClustering();
        });
        
        // Add scale control
        L.control.scale({
            position: 'bottomleft',
            imperial: true,
            metric: true
        }).addTo(map);
        
        // Create a marker cluster group for earthquake markers with custom options
        var markerClusterGroup = L.markerClusterGroup({
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            spiderfyOnMaxZoom: true,
            removeOutsideVisibleBounds: true,
            disableClusteringAtZoom: 10, // Disable clustering at high zoom levels
            maxClusterRadius: 80, // Adjust cluster size (smaller value = more clusters)
            
            // Custom icon creation function for clusters
            iconCreateFunction: function(cluster) {
                var childCount = cluster.getChildCount();
                var maxMag = 0;
                var totalMag = 0;
                
                // Find the maximum magnitude in the cluster
                cluster.getAllChildMarkers().forEach(function(marker) {
                    if (marker.feature) {
                        var mag = marker.feature.properties.mag;
                        maxMag = Math.max(maxMag, mag);
                        totalMag += mag;
                    }
                });
                
                // Average magnitude (for color intensity)
                var avgMag = totalMag / childCount;
                
                // Determine class based on child count and max magnitude
                var c = ' marker-cluster-';
                if (childCount < 10) {
                    c += 'small';
                } else if (childCount < 50) {
                    c += 'medium';
                } else if (childCount < 100) {
                    c += 'large';
                } else {
                    c += 'xlarge';
                }
                
                // Adjust size based on child count
                var size = Math.min(70, Math.max(40, 30 + childCount / 10));
                
                return new L.DivIcon({
                    html: '<div style="width:' + size + 'px;height:' + size + 'px;"><span>' + childCount + '</span></div>',
                    className: 'marker-cluster' + c,
                    iconSize: new L.Point(size, size)
                });
            }
        });
        
        // Add the cluster group to the map
        map.addLayer(markerClusterGroup);
        
        // Create a regular layer group for when clustering is disabled
        var earthquakesNoCluster = L.layerGroup();
        
        // Variable to track current active layer
        var earthquakes = markerClusterGroup; // Default to clustered
        var clusteringEnabled = true;
        
        // Variables to store current settings
        var currentPeriod = '1day';
        var currentMagnitude = '4.5';
        
        // Add event listeners for earthquake time period buttons
        document.getElementById('btnPast24Hours').addEventListener('click', function() {
            setActiveButton(this);
            currentPeriod = '1day';
            fetchEarthquakeData();
        });
        
        document.getElementById('btnPast7Days').addEventListener('click', function() {
            setActiveButton(this);
            currentPeriod = '7days';
            fetchEarthquakeData();
        });
        
        document.getElementById('btnPast30Days').addEventListener('click', function() {
            setActiveButton(this);
            currentPeriod = '30days';
            fetchEarthquakeData();
        });
        
        document.getElementById('btnRefresh').addEventListener('click', function() {
            fetchEarthquakeData();
        });
        
        // Add event listener for magnitude filter
        document.getElementById('minMagnitude').addEventListener('change', function() {
            currentMagnitude = this.value;
            fetchEarthquakeData();
        });
        
        // Helper function to set active button
        function setActiveButton(button) {
            // Remove active class from all buttons
            document.querySelectorAll('.eq-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            // Add active class to clicked button
            button.classList.add('active');
        }
        
        // Function to determine marker size based on magnitude
        function getMarkerSize(magnitude) {
            return magnitude * 5;
        }
        
        // Function to determine marker color based on depth
        function getMarkerColor(depth) {
            return depth > 300 ? '#d73027' :
                   depth > 100 ? '#fc8d59' :
                   depth > 50 ? '#fee08b' :
                   depth > 10 ? '#d9ef8b' :
                              '#91cf60';
        }
        
        // Function to create a marker for an earthquake
        function createEarthquakeMarker(feature) {
            var magnitude = feature.properties.mag;
            var depth = feature.geometry.coordinates[2];
            var latlng = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
            
            var markerOptions = {
                radius: getMarkerSize(magnitude),
                fillColor: getMarkerColor(depth),
                color: '#000',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            };
            
            var marker = L.circleMarker(latlng, markerOptions);
            
            // Create popup content
            var popupContent = `
                <strong>Magnitude:</strong> ${magnitude}<br>
                <strong>Location:</strong> ${feature.properties.place}<br>
                <strong>Depth:</strong> ${depth} km<br>
                <strong>Time:</strong> ${new Date(feature.properties.time).toLocaleString()}<br>
                <a href="${feature.properties.url}" target="_blank">More details</a>
            `;
            
            marker.bindPopup(popupContent);
            
            return marker;
        }
        
        // Function to fetch earthquake data from USGS API
        function fetchEarthquakeData() {
            // Clear existing markers from both layer groups
            markerClusterGroup.clearLayers();
            earthquakesNoCluster.clearLayers();
            
            // Update loading state
            document.getElementById('earthquakeList').innerHTML = '<div class="loading">Loading earthquake data...</div>';
            
            // Build the API URL based on current settings
            var magnitudeFilter = currentMagnitude === 'all' ? '' : `&minmagnitude=${currentMagnitude}`;
            var apiUrl = `https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_${currentPeriod}.geojson${magnitudeFilter}`;
            
            // Fetch the data
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    // Process the earthquake data
                    processEarthquakeData(data);
                    
                    // Update last updated time
                    document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleString();
                })
                .catch(error => {
                    console.error('Error fetching earthquake data:', error);
                    document.getElementById('earthquakeList').innerHTML = '<div class="loading">Error loading earthquake data. Please try again.</div>';
                });
        }
        
        // Global variables for timeline
        var timelineData = [];
        var animationInterval;
        var isPlaying = false;
        var currentTimeIndex = 0;
        var animationSpeed = 1000; // Default speed in milliseconds
        
        // Function to process earthquake data and add to map
        function processEarthquakeData(data) {
            // Sort earthquakes by magnitude (descending) for the list
            var sortedByMagnitude = data.features.sort((a, b) => b.properties.mag - a.properties.mag);
            
            // Sort earthquakes by time (ascending) for the timeline
            timelineData = [...data.features].sort((a, b) => a.properties.time - b.properties.time);
            
            // Add markers to the map
            sortedByMagnitude.forEach(feature => {
                // Add feature to the marker for reference
                var marker = createEarthquakeMarker(feature);
                marker.feature = feature;
                
                // Add to the appropriate layer group
                if (clusteringEnabled) {
                    markerClusterGroup.addLayer(marker);
                } else {
                    earthquakesNoCluster.addLayer(marker);
                }
            });
            
            // Update the earthquake list
            updateEarthquakeList(sortedByMagnitude.slice(0, 10)); // Show top 10 earthquakes
            
            // Set up timeline
            setupTimeline();
        }
        
        // Function to update the earthquake list
        function updateEarthquakeList(features) {
            var listHtml = '';
            
            if (features.length === 0) {
                listHtml = '<div class="loading">No earthquakes found matching your criteria.</div>';
            } else {
                features.forEach(feature => {
                    var magnitude = feature.properties.mag;
                    var location = feature.properties.place || 'Unknown location';
                    var time = new Date(feature.properties.time).toLocaleString();
                    
                    listHtml += `
                        <div class="earthquake-item" data-id="${feature.id}">
                            <strong>M${magnitude.toFixed(1)}</strong> - ${location}<br>
                            <small>${time}</small>
                        </div>
                    `;
                });
            }
            
            document.getElementById('earthquakeList').innerHTML = listHtml;
            
            // Add click event listeners to earthquake items
            document.querySelectorAll('.earthquake-item').forEach(item => {
                item.addEventListener('click', function() {
                    var featureId = this.getAttribute('data-id');
                    var feature = features.find(f => f.id === featureId);
                    
                    if (feature) {
                        var latlng = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
                        map.setView(latlng, 6);
                        
                        // Find and open the popup for this earthquake
                        earthquakes.eachLayer(layer => {
                            if (layer.getLatLng().lat === latlng[0] && layer.getLatLng().lng === latlng[1]) {
                                layer.openPopup();
                            }
                        });
                    }
                });
            });
        }
        
        // Add a legend to the map
        function addLegend() {
            var legend = L.control({position: 'bottomright'});
            
            legend.onAdd = function(map) {
                var div = L.DomUtil.create('div', 'legend');
                var depths = [0, 10, 50, 100, 300];
                var labels = [];
                
                div.innerHTML = '<h4>Earthquake Depth</h4>';
                
                // Loop through depth intervals and generate a label with a colored square for each interval
                for (var i = 0; i < depths.length; i++) {
                    div.innerHTML += 
                        '<i style="background:' + getMarkerColor(depths[i] + 1) + '"></i> ' +
                        (depths[i + 1] ? depths[i] + '&ndash;' + depths[i + 1] + ' km<br>' : depths[i] + '+ km');
                }
                
                return div;
            };
            
            legend.addTo(map);
        }
        
        // Add info panel to the map
        function addInfoPanel() {
            var info = L.control({position: 'topright'});
            
            info.onAdd = function(map) {
                var div = L.DomUtil.create('div', 'info-panel');
                div.innerHTML = `
                    <h4>Earthquake Monitor</h4>
                    <p>Click on a circle to see details about the earthquake.</p>
                    <p>Circle size indicates magnitude, and color indicates depth.</p>
                `;
                return div;
            };
            
            info.addTo(map);
        }
        
        // WebSocket connection for real-time updates
        var socket;
        var isWebSocketConnected = false;
        
        // Function to set up WebSocket connection
        function setupWebSocketConnection() {
            // Check if browser supports WebSockets
            if ("WebSocket" in window) {
                // Connect to WebSocket server (we'll create this server)
                socket = new WebSocket("ws://localhost:8080");
                
                socket.onopen = function() {
                    console.log("WebSocket connection established");
                    isWebSocketConnected = true;
                    
                    // Update connection status in UI
                    updateConnectionStatus(true);
                    
                    // Request initial data
                    socket.send(JSON.stringify({
                        type: 'requestData',
                        period: currentPeriod,
                        magnitude: currentMagnitude
                    }));
                };
                
                socket.onmessage = function(event) { 
                    console.log("Message received from server");
                    var data = JSON.parse(event.data);
                    
                    if (data.type === 'fullData') {
                        // Stop any running animation before processing new data
                        if (isPlaying) {
                            clearInterval(animationInterval);
                            isPlaying = false;
                            document.getElementById('playButton').textContent = "▶ Play";
                        }
                        
                        // Process complete dataset
                        processEarthquakeData(data.earthquakeData);
                        
                        // Update last updated time
                        document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleString();
                    } 
                    else if (data.type === 'newEarthquake') {
                        // Process single new earthquake
                        processNewEarthquake(data.earthquake);
                    }
                };
                
                socket.onclose = function() { 
                    console.log("WebSocket connection closed");
                    isWebSocketConnected = false;
                    
                    // Update connection status in UI
                    updateConnectionStatus(false);
                    
                    // Attempt to reconnect after a delay
                    setTimeout(setupWebSocketConnection, 5000);
                };
                
                socket.onerror = function(error) {
                    console.error("WebSocket error:", error);
                    
                    // Fall back to traditional polling if WebSocket fails
                    if (!isWebSocketConnected) {
                        console.log("Falling back to polling method");
                        fetchEarthquakeData();
                        
                        // Set up polling as fallback
                        if (!window.pollingInterval) {
                            window.pollingInterval = setInterval(fetchEarthquakeData, 5 * 60 * 1000);
                        }
                    }
                };
            } else {
                console.log("WebSocket not supported by your browser, falling back to polling");
                
                // Fall back to traditional polling
                fetchEarthquakeData();
                
                // Set up polling as fallback
                if (!window.pollingInterval) {
                    window.pollingInterval = setInterval(fetchEarthquakeData, 5 * 60 * 1000);
                }
            }
        }
        
        // Function to update connection status in UI
        function updateConnectionStatus(isConnected) {
            var statusElement = document.getElementById('connectionStatus');
            
            if (!statusElement) {
                // Create status element if it doesn't exist
                statusElement = document.createElement('div');
                statusElement.id = 'connectionStatus';
                statusElement.className = 'connection-status';
                document.querySelector('.refresh-container').appendChild(statusElement);
            }
            
            if (isConnected) {
                statusElement.innerHTML = '<span class="status-indicator connected"></span> Real-time updates active';
                statusElement.classList.add('connected');
                statusElement.classList.remove('disconnected');
            } else {
                statusElement.innerHTML = '<span class="status-indicator disconnected"></span> Real-time updates inactive';
                statusElement.classList.add('disconnected');
                statusElement.classList.remove('connected');
            }
        }
        
        // Function to process a single new earthquake
        function processNewEarthquake(feature) {
            console.log("Processing new earthquake:", feature.properties.place);
            
            // Create marker with feature reference
            var marker = createEarthquakeMarker(feature);
            marker.feature = feature;
            
            // Add the new earthquake to the map if we're showing the latest data
            if (currentTimeIndex >= timelineData.length - 1 || !timelineData.length) {
                if (clusteringEnabled) {
                    markerClusterGroup.addLayer(marker);
                } else {
                    earthquakesNoCluster.addLayer(marker);
                }
            }
            
            // Add to timeline data
            if (timelineData.length > 0) {
                // Insert in correct chronological position
                let inserted = false;
                for (let i = 0; i < timelineData.length; i++) {
                    if (feature.properties.time < timelineData[i].properties.time) {
                        timelineData.splice(i, 0, feature);
                        inserted = true;
                        break;
                    }
                }
                
                // If not inserted, add to the end
                if (!inserted) {
                    timelineData.push(feature);
                    
                    // Update timeline end label
                    var endTime = new Date(feature.properties.time);
                    document.getElementById('timelineEnd').textContent = formatDate(endTime);
                }
                
                // Update timeline slider max value
                var timelineSlider = document.getElementById('timelineSlider');
                if (timelineSlider) {
                    timelineSlider.max = timelineData.length - 1;
                    
                    // If we're at the end, update the slider position
                    if (currentTimeIndex >= timelineData.length - 2) {
                        currentTimeIndex = timelineData.length - 1;
                        timelineSlider.value = currentTimeIndex;
                        
                        // Update current time display
                        var currentTime = new Date(timelineData[currentTimeIndex].properties.time);
                        document.getElementById('currentTimeDisplay').textContent = "Current Time: " + formatDateTime(currentTime);
                    }
                }
            } else {
                // First earthquake, initialize timeline data
                timelineData = [feature];
                setupTimeline();
            }
            
            // Check if we need to update the earthquake list
            // (only if it's significant enough to be in the top 10)
            var currentFeatures = [];
            document.querySelectorAll('.earthquake-item').forEach(item => {
                var featureId = item.getAttribute('data-id');
                var feature = earthquakes.getLayers().find(layer => layer.feature && layer.feature.id === featureId);
                if (feature) {
                    currentFeatures.push(feature.feature);
                }
            });
            
            // Add the new earthquake to the list
            currentFeatures.push(feature);
            
            // Sort by magnitude
            currentFeatures.sort((a, b) => b.properties.mag - a.properties.mag);
            
            // Update the list with top 10
            updateEarthquakeList(currentFeatures.slice(0, 10));
            
            // Notify user of significant earthquakes
            if (feature.properties.mag >= 5.0) {
                notifyUser(feature);
            }
        }
        
        // Function to notify user of significant earthquakes
        function notifyUser(earthquake) {
            // Check if browser supports notifications
            if (!("Notification" in window)) {
                console.log("This browser does not support desktop notification");
                return;
            }
            
            // Check if permission is already granted
            if (Notification.permission === "granted") {
                createNotification(earthquake);
            }
            // Otherwise, request permission
            else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(function (permission) {
                    if (permission === "granted") {
                        createNotification(earthquake);
                    }
                });
            }
        }
        
        function createNotification(earthquake) {
            var magnitude = earthquake.properties.mag;
            var location = earthquake.properties.place || "Unknown location";
            
            var notification = new Notification("Significant Earthquake Detected", {
                body: `Magnitude ${magnitude.toFixed(1)} earthquake near ${location}`,
                icon: "https://earthquake.usgs.gov/theme/images/usgs-logo.png" // USGS logo as fallback
            });
            
            notification.onclick = function() {
                // Focus on this earthquake when notification is clicked
                var latlng = [earthquake.geometry.coordinates[1], earthquake.geometry.coordinates[0]];
                map.setView(latlng, 6);
                window.focus();
                
                // Find and open the popup for this earthquake
                earthquakes.eachLayer(layer => {
                    if (layer.getLatLng().lat === latlng[0] && layer.getLatLng().lng === latlng[1]) {
                        layer.openPopup();
                    }
                });
            };
        }
        
        // Update event listeners for earthquake time period buttons to send WebSocket messages
        document.getElementById('btnPast24Hours').addEventListener('click', function() {
            setActiveButton(this);
            currentPeriod = '1day';
            
            if (isWebSocketConnected) {
                // Request data via WebSocket
                socket.send(JSON.stringify({
                    type: 'requestData',
                    period: currentPeriod,
                    magnitude: currentMagnitude
                }));
            } else {
                // Fall back to traditional fetch
                fetchEarthquakeData();
            }
        });
        
        document.getElementById('btnPast7Days').addEventListener('click', function() {
            setActiveButton(this);
            currentPeriod = '7days';
            
            if (isWebSocketConnected) {
                // Request data via WebSocket
                socket.send(JSON.stringify({
                    type: 'requestData',
                    period: currentPeriod,
                    magnitude: currentMagnitude
                }));
            } else {
                // Fall back to traditional fetch
                fetchEarthquakeData();
            }
        });
        
        document.getElementById('btnPast30Days').addEventListener('click', function() {
            setActiveButton(this);
            currentPeriod = '30days';
            
            if (isWebSocketConnected) {
                // Request data via WebSocket
                socket.send(JSON.stringify({
                    type: 'requestData',
                    period: currentPeriod,
                    magnitude: currentMagnitude
                }));
            } else {
                // Fall back to traditional fetch
                fetchEarthquakeData();
            }
        });
        
        // Update refresh button to use WebSocket when available
        document.getElementById('btnRefresh').addEventListener('click', function() {
            if (isWebSocketConnected) {
                // Request fresh data via WebSocket
                socket.send(JSON.stringify({
                    type: 'requestData',
                    period: currentPeriod,
                    magnitude: currentMagnitude
                }));
            } else {
                // Fall back to traditional fetch
                fetchEarthquakeData();
            }
        });
        
        // Update magnitude filter to use WebSocket when available
        document.getElementById('minMagnitude').addEventListener('change', function() {
            currentMagnitude = this.value;
            
            if (isWebSocketConnected) {
                // Request data via WebSocket with new magnitude filter
                socket.send(JSON.stringify({
                    type: 'requestData',
                    period: currentPeriod,
                    magnitude: currentMagnitude
                }));
            } else {
                // Fall back to traditional fetch
                fetchEarthquakeData();
            }
        });
        
        // Function to set up the timeline
        function setupTimeline() {
            if (timelineData.length === 0) {
                console.log("No timeline data available");
                return;
            }
            
            var timelineSlider = document.getElementById('timelineSlider');
            var playButton = document.getElementById('playButton');
            var speedSelect = document.getElementById('animationSpeed');
            var timelineStart = document.getElementById('timelineStart');
            var timelineEnd = document.getElementById('timelineEnd');
            var currentTimeDisplay = document.getElementById('currentTimeDisplay');
            
            // Set up the timeline range
            timelineSlider.min = 0;
            timelineSlider.max = timelineData.length - 1;
            timelineSlider.value = timelineData.length - 1; // Start at most recent
            currentTimeIndex = timelineData.length - 1;
            
            // Set timeline labels with actual dates
            var startTime = new Date(timelineData[0].properties.time);
            var endTime = new Date(timelineData[timelineData.length - 1].properties.time);
            
            timelineStart.textContent = formatDate(startTime);
            timelineEnd.textContent = formatDate(endTime);
            currentTimeDisplay.textContent = "Current Time: " + formatDateTime(endTime);
            
            // Update map when slider changes
            timelineSlider.addEventListener('input', function() {
                currentTimeIndex = parseInt(this.value);
                updateMapToTime(currentTimeIndex);
                
                // Update current time display
                if (currentTimeIndex < timelineData.length) {
                    var currentTime = new Date(timelineData[currentTimeIndex].properties.time);
                    currentTimeDisplay.textContent = "Current Time: " + formatDateTime(currentTime);
                }
            });
            
            // Play/pause button
            playButton.addEventListener('click', function() {
                togglePlayPause();
            });
            
            // Speed control
            speedSelect.addEventListener('change', function() {
                animationSpeed = parseInt(this.value);
                
                // If currently playing, restart with new speed
                if (isPlaying) {
                    clearInterval(animationInterval);
                    startAnimation();
                }
            });
            
            // Initialize animation speed from select
            animationSpeed = parseInt(speedSelect.value);
            
            // Show all earthquakes initially
            updateMapToTime(timelineData.length - 1);
        }
        
        // Function to toggle play/pause
        function togglePlayPause() {
            var playButton = document.getElementById('playButton');
            
            if (isPlaying) {
                // Pause the animation
                clearInterval(animationInterval);
                playButton.textContent = "▶ Play";
                isPlaying = false;
            } else {
                // Start the animation
                playButton.textContent = "⏸ Pause";
                isPlaying = true;
                
                // If we're at the end, start from beginning
                if (currentTimeIndex >= timelineData.length - 1) {
                    currentTimeIndex = 0;
                    document.getElementById('timelineSlider').value = 0;
                    updateMapToTime(0);
                }
                
                startAnimation();
            }
        }
        
        // Function to start the animation
        function startAnimation() {
            animationInterval = setInterval(function() {
                // Increment the current index
                currentTimeIndex++;
                
                // Update the slider position
                document.getElementById('timelineSlider').value = currentTimeIndex;
                
                // Update the map
                updateMapToTime(currentTimeIndex);
                
                // Update current time display
                if (currentTimeIndex < timelineData.length) {
                    var currentTime = new Date(timelineData[currentTimeIndex].properties.time);
                    document.getElementById('currentTimeDisplay').textContent = "Current Time: " + formatDateTime(currentTime);
                }
                
                // If we've reached the end, stop the animation
                if (currentTimeIndex >= timelineData.length - 1) {
                    clearInterval(animationInterval);
                    document.getElementById('playButton').textContent = "▶ Play";
                    isPlaying = false;
                }
            }, animationSpeed);
        }
        
        // Function to toggle clustering on/off
        function toggleClustering() {
            var clusterButton = document.getElementById('btnCluster');
            
            if (clusteringEnabled) {
                // Switch to non-clustered view
                map.removeLayer(markerClusterGroup);
                map.addLayer(earthquakesNoCluster);
                earthquakes = earthquakesNoCluster;
                clusteringEnabled = false;
                clusterButton.textContent = "Clustering Off";
                clusterButton.classList.remove('active');
            } else {
                // Switch to clustered view
                map.removeLayer(earthquakesNoCluster);
                map.addLayer(markerClusterGroup);
                earthquakes = markerClusterGroup;
                clusteringEnabled = true;
                clusterButton.textContent = "Clustering On";
                clusterButton.classList.add('active');
            }
            
            // Update the map with current data
            if (timelineData.length > 0) {
                updateMapToTime(currentTimeIndex);
            }
        }
        
        // Function to update the map to show earthquakes up to a specific time
        function updateMapToTime(index) {
            // Clear existing markers from both layer groups
            markerClusterGroup.clearLayers();
            earthquakesNoCluster.clearLayers();
            
            // Add earthquakes up to the selected time
            for (var i = 0; i <= index && i < timelineData.length; i++) {
                var marker = createEarthquakeMarker(timelineData[i]);
                marker.feature = timelineData[i];
                
                // Add to the appropriate layer group
                if (clusteringEnabled) {
                    markerClusterGroup.addLayer(marker);
                } else {
                    earthquakesNoCluster.addLayer(marker);
                }
            }
        }
        
        // Helper function to format date for timeline labels
        function formatDate(date) {
            return date.toLocaleDateString();
        }
        
        // Helper function to format date and time
        function formatDateTime(date) {
            return date.toLocaleString();
        }
        
        // Initialize the application
        function init() {
            // Add legend and info panel
            addLegend();
            addInfoPanel();
            
            // Request notification permission early
            if ("Notification" in window) {
                Notification.requestPermission();
            }
            
            // Try to set up WebSocket connection
            setupWebSocketConnection();
            
            // Set up fallback polling if WebSocket fails
            // This is now handled in the WebSocket error handler
        }
        
        // Start the application when the page loads
        window.onload = init;
    </script>
</body>
</html>